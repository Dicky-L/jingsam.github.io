---
title: mapbox-gl-js接入大GeoJSON数据的优化策略
date: 2017-10-23 09:35:06
tags:
---

mapbox-gl-js可以接受GeoJSON数据，在前端动态地绘制GeoJSON数据。需要说明的是，mapbox-gl-js并不能直接渲染GeoJSON数据，而是通过`geojson-vt`这个库，在前端动态地将GeoJSON数据转换为矢量瓦片后渲染。至于为什么不支持直接渲染GeoJSON数据，我猜想是因为mapbox-gl-js对于点、线、面、符号、注记等要素的绘制规则都是基于矢量瓦片的，为GeoJSON另外实现一套绘制规则，不仅增大了实现成本，而且两套规则可能会出现冲突。

传统的矢量数据需要预先切片、存储、发布服务，并且当数据更新时又得重新切片，对于小项目来说有点大炮打蚊子的感觉。GeoJSON数据源的好处是接入容易、更新方便，并且市面上有很多工具可以将各种矢量数据转换为GeoJSON格式。

通常来说，GeoJSON数据源适合于少量的矢量数据，大批量的矢量数据最好还是预先切片。但多少数据算是”少量数据呢“？从经验上讲，应该将GeoJSON数据控制在20M以下。需要说明的是，之所以提出”20M“这个经验值，并不是因为mapbox-gl-js对于渲染超过20M的GeoJOSN数据有困难，而是综合考虑网络请求时间和解析数据的时间。实际上，mapbox-gl-js处理200M的GeoJSON数据都没有什么问题，但是把大量的GeoJSON数据整体请求过来所产生的耗时，会严重影响用户体验。所以对于大量的GeoJSON数据，最好预先切片，这样前端可以分块请求，减少网络请求时间和解析数据的时间。

虽然使用GeoJSON大文件作为数据源不是最佳选择，但有些情况下我们不得不使用GeoJSON作为数据源，例如数据是由第三方通过API提供的、数据是实时更新的。当接入大GeoJSON数据时，我们可以通过以下几种优化策略，提高地图绘制的效率。


# 使用cluster选项

如果需要接入的数据是点数据，并且十分密集，这时应该对点进行聚合。特别密集的点在小缩放级别会重叠在一起，造成注记压盖叠加，可视化效果不好。使用聚合后，小的缩放级别显示聚合数据，大的缩放级别显示原始数据，兼顾了综合和细节。并且，聚合减少了单张瓦片的数据量，使得引擎绘制更快，交互更流畅。

mapbox-gl-js是通过`supercluster`这个库对GeoJSON数据进行聚合。其原理是两个点的显示距离小于聚合半径时，聚合为一个点要素，这个点会有一个`point_count`字段记录聚合的点的数目。需要注意的是，并不是每个层级上所有的点都被聚合，有些孤立的点会保留原位。那么如何区分聚合的和未聚合的点要素呢？可以使用有没有`point_cluster`进行判断，即使用`"filter": ["has", "point_count"]`过滤出聚合的点要素，使用`"filter": ["!has", "point_count"]`过滤出未聚合的点要素。

mapbox-gl-js通过`cluster`、`clusterRadius`、`clusterMaxZoom`三个参数控制点聚合的效果，并且是要在`source`里面配置。从逻辑上讲，这三个是控制聚合的效果的，应该放到`layer`上更符合直觉。然而，mapbox-gl-js的聚合过程并不是在渲染层实现的，而是在数据层实现的，即在动态切片的时候对数据做了聚合操作。所以，从实现角度来讲，将聚合控制参数放在`source`是合情合理的。以下是这三个参数的说明：

- `cluster`：设为`true`开启GeoJSON数据聚合，只对点数据有效。
- `clusterRaius`：聚合半径，默认为50像素。当你发现有很多点没有被聚合时，可以适当调大这个参数。
- `clusterMaxZoom`：聚合的最大层级，大于这个层级的数据不再聚合，默认值是`maxzoom - 1`。

# 减小buffer


# 减小maxzoom


# 增大minzoom


# 对数据进行minify


# 使用URL加载数据


# 渲染时允许符号重叠


# 对数据进行切分


# 预先切片





